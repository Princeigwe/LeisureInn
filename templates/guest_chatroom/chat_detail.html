{% load static %}



<!DOCTYPE html>
<html lang="en">
	
<head>
		<meta charset="utf-8">
		<title>Swipe â€“ The Simplest Chat Platform</title>
		<meta name="description" content="#">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- Bootstrap core CSS -->
		<link href="{% static 'chat/dist/css/lib/bootstrap.min.css' %}" type="text/css" rel="stylesheet">
		<!-- Swipe core CSS -->
		<link href="{% static 'chat/dist/css/swipe.min.css' %}" type="text/css" rel="stylesheet">
		<!-- Favicon -->
		<link href="{% static 'chat/dist/img/favicon.png' %}" type="image/png" rel="icon">
	</head>
	<body>

		

		<main>
			<div class="layout">
				<!-- Start of Navigation -->
				<!-- End of Navigation -->

				<!-- Start of Sidebar -->
				<!-- End of Sidebar -->

				<!-- Start of Add Friends -->
				<!-- End of Add Friends -->

				<!-- Start of Create Chat -->
				<!-- End of Create Chat -->

				<div class="main">
					<div class="tab-content" id="nav-tabContent">
						<!-- Start of Babble -->
						<!-- <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list"> -->
						

                            <!-- list chat here -->

                            <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list">
                                <!-- Start of Chat -->
                                <div class="chat" id="chat1">
                                    <div class="top">
                                        <div class="container">
                                            <div class="col-md-12">
                                                <div class="inside">
                                                    <a href="#"><img class="avatar-md" src="{% static 'chat/dist/img/avatars/avatar-female-5.jpg' %}" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar"></a>
                                                    <div class="status">
                                                        <i class="material-icons online">fiber_manual_record</i>
                                                    </div>
                                                    
													{% if user.is_superuser %}
														<div class="data">
															<h5><a href="#"> {{room.guest.first_name}} {{room.guest.last_name}} </a></h5>
															<span> {{room.guest.email}} </span>
														</div>
														{% else %}
														<div class="data">
															<h5><a href="#"> {{room.admin.first_name}} {{room.admin.last_name}} </a></h5>
															<span> {{room.admin.email}} </span>
														</div>
													{% endif %}
														
                                                    <button class="btn connect d-md-block d-none" name="1"><i class="material-icons md-30">phone_in_talk</i></button>
                                                    <button class="btn connect d-md-block d-none" name="1"><i class="material-icons md-36">videocam</i></button>
                                                    <button class="btn d-md-block d-none"><i class="material-icons md-30">info</i></button>
                                                    <div class="dropdown">
                                                        <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <button class="dropdown-item connect" name="1"><i class="material-icons">phone_in_talk</i>Voice Call</button>
                                                            <button class="dropdown-item connect" name="1"><i class="material-icons">videocam</i>Video Call</button>
                                                            <hr>
                                                            <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>
                                                            <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>
                                                            <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="content" id="content">
                                        <div class="container">
                                            <div class="col-md-12">
                                                <!-- <div class="date">
                                                    <hr>
                                                    <span>Yesterday</span>
                                                    <hr>
                                                </div>
                                                <div class="message">
                                                    <img class="avatar-md" src="{% static 'chat/dist/img/avatars/avatar-female-5.jpg' %}" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar">
                                                    <div class="text-main">
                                                        <div class="text-group">
                                                            <div class="text">
                                                                <p>We've got some killer ideas kicking about already.</p>
                                                            </div>
                                                        </div>
                                                        <span>09:46 AM</span>
                                                    </div>
                                                </div>
                                                <div class="message me">
                                                    <div class="text-main">
                                                        <div class="text-group me">
                                                            <div class="text me">
                                                                <p>Can't wait! How are we coming along with the client?</p>
                                                            </div>
                                                        </div>
                                                        <span>11:32 AM</span>
                                                    </div>
                                                </div> -->

                                                
                                                <ul id="message-list">

												</ul>
                                                    
                                            </div>
                                        </div>
                                    </div>
                                    <div class="container">
                                        <div class="col-md-12">
                                            <div class="bottom">
                                                <form id="message-form" class="position-relative w-100" method="post">
                                                    {% csrf_token %}
                                                    <textarea class="form-control" name="content" id="message"  placeholder="Start typing for reply..." rows="1" name="content"></textarea>
                                                    <!-- <button class="btn emoticons"><i class="material-icons">insert_emoticon</i></button> -->
                                                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                                                </form>
                                                <!-- <label>
                                                    <input type="file">
                                                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                                                </label>  -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

							<!-- End of Chat -->
							<!-- Start of Call -->
							<div class="call" id="call1">
								<div class="content">
									<div class="container">
										<div class="col-md-12">
											<div class="inside">
												<div class="panel">
													<div class="participant">
														<img class="avatar-xxl" src="{% static 'chat/dist/img/avatars/avatar-female-5.jpg' %}" alt="avatar">
														<span>Connecting</span>
													</div>							
													<div class="options">
														<button class="btn option"><i class="material-icons md-30">mic</i></button>
														<button class="btn option"><i class="material-icons md-30">videocam</i></button>
														<button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>
														<button class="btn option"><i class="material-icons md-30">person_add</i></button>
														<button class="btn option"><i class="material-icons md-30">volume_up</i></button>
													</div>
													<button class="btn back" name="1"><i class="material-icons md-24">chat</i></button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<!-- End of Call -->
						</div>
						<!-- End of Babble -->
						<!-- Start of Babble -->
						

                        <!-- for list empty here -->

						<!-- End of Babble -->
						<!-- Start of Babble -->
						<div class="babble tab-pane fade" id="list-request" role="tabpanel" aria-labelledby="list-request-list">
							<!-- Start of Chat -->
							<div class="chat" id="chat3">
								<div class="top">
									<div class="container">
										<div class="col-md-12">
											<div class="inside">
												<a href="#"><img class="avatar-md" src="{% static 'chat/dist/img/avatars/avatar-female-6.jpg' %}" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>
												<div class="status">
													<i class="material-icons offline">fiber_manual_record</i>
												</div>
												<div class="data">
													<h5><a href="#">Louis Martinez</a></h5>
													<span>Inactive</span>
												</div>
												<button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-30">phone_in_talk</i></button>
												<button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-36">videocam</i></button>
												<button class="btn d-md-block disabled d-none" disabled><i class="material-icons md-30">info</i></button>
												<div class="dropdown">
													<button class="btn disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled><i class="material-icons md-30">more_vert</i></button>
													<div class="dropdown-menu dropdown-menu-right">
														<button class="dropdown-item"><i class="material-icons">phone_in_talk</i>Voice Call</button>
														<button class="dropdown-item"><i class="material-icons">videocam</i>Video Call</button>
														<hr>
														<button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>
														<button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>
														<button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="content empty">
									<div class="container">
										<div class="col-md-12">
											<div class="no-messages request">
												<a href="#"><img class="avatar-xl" src="{% static 'chat/dist/img/avatars/avatar-female-6.jpg' %}" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>
												<h5>Louis Martinez would like to add you as a contact. <span>Hi Keith, I'd like to add you as a contact.</span></h5>
												<div class="options">
													<button class="btn button"><i class="material-icons">check</i></button>
													<button class="btn button"><i class="material-icons">close</i></button>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="container">
									<div class="col-md-12">
										<div class="bottom">
											<form class="position-relative w-100">
												<textarea class="form-control" placeholder="Messaging unavailable" rows="1" disabled></textarea>
												<button class="btn emoticons disabled" disabled><i class="material-icons">insert_emoticon</i></button>
												<button class="btn send disabled" disabled><i class="material-icons">send</i></button>
											</form>
											<label>
												<input type="file" disabled>
												<span class="btn attach disabled d-sm-block d-none"><i class="material-icons">attach_file</i></span>
											</label> 
										</div>
									</div>
								</div>
							</div>
							<!-- End of Chat -->
						</div>
						<!-- End of Babble -->
					</div>
				</div>
			</div> <!-- Layout -->
		</main>
		<!-- Bootstrap/Swipe core JavaScript
		================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<script src="{% static 'chat/dist/js/jquery-3.3.1.slim.min.js' %}" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script>window.jQuery || document.write('<script src="static/chat/dist/js/vendor/jquery-slim.min.js"><\/script>')</script>
		<script src="{% static 'chat/dist/js/vendor/popper.min.js' %}"></script>
		<script src="{% static 'chat/dist/js/swipe.min.js' %}"></script>
		<script src="{% static 'chat/dist/js/bootstrap.min.js' %}"></script>
		<script>
			function scrollToBottom(el) { el.scrollTop = el.scrollHeight; }
			scrollToBottom(document.getElementById('content'));
		</script>

        {{room_id|json_script:"room-id"}}

		<!-- websocket script -->
        <script>

			
            const roomId = JSON.parse(document.getElementById('room-id').textContent);
            const chatRoomSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
            );

            chatRoomSocket.onopen = function(e){
                console.log("Websocket Connected");
				fetchMessages();
            }

            chatRoomSocket.onmessage = function(e){

				console.log(e)
				var data = JSON.parse(e.data);
				
				if (data['command'] === 'messages') {
					for (let i = 0; i < data['messages'].length; i++) {
						createMessage(data['messages'][i]);
					}
				}else if (data['command'] === 'new_message'){
					createMessage(data['message']);
				}
				
				
				
			};

			chatRoomSocket.onclose = function(e){
				console.log("Connection is closed");
			}

			chatRoomSocket.onerror = function(e){
				console.log('Something went wrong');
			}


			// for sending the messages
			const messageForm = document.getElementById('message-form') // calling the message form by ID
			messageForm.addEventListener('submit', sendMessage) // making the form listen to events to send message when submitted
			function sendMessage(e){
				if (e.preventDefault) e.preventDefault();
				const message = document.getElementById('message').value;

				if (message=="") {
					return false;
				}

				chatRoomSocket.send(
					JSON.stringify({
						'command': 'new_message',
						'message': message,
						// 'from': username
					})
				); 
				messageForm.reset();
				gotoBottom();
				return false;
			}
			
			// fetching messages with the consumers fetch_messages function
			function fetchMessages(){
				chatRoomSocket.send(JSON.stringify({'command': 'fetch_messages'}));
			}

			
			var user_first_name = '{{user_first_name}}';

			function createMessage(data){
				var sender = data['sender'];
				console.log('data',sender)

				msgListTag = document.createElement('li');

				textMainTag = document.createElement('div');
				textGroupTag = document.createElement('div');
				textTag = document.createElement('div');

				pTag = document.createElement('p');
				spanTag = document.createElement('span');
				pTag.textContent = data.content;
				spanTag.textContent = data.timestamp;
				const chat_log = document.getElementById('message-list');

				textMainTag.className = "text-main";
				textGroupTag.className = "text-group me";
				textTag.className = "text me";
				if (sender === user_first_name){
					msgListTag.className = "message me";
				}else{
					msgListTag.className = 'message';
					textGroupTag.className = "text-group";
					textTag.className = "text";
				}

				// msgListTag.className = "message me";
				textTag.appendChild(pTag);
				textGroupTag.appendChild(textTag);
				textMainTag.appendChild(textGroupTag);
				// textMainTag.appendChild(spanTag);
				msgListTag.appendChild(textMainTag);
				chat_log.appendChild(msgListTag);
			}

        </script>
	</body>

</html>